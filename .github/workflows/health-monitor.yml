# GitHub Actions Workflow for FixtureCast Health Monitoring
# Runs every 12 hours to check system health and auto-restart if needed

name: Health Monitor

on:
  schedule:
    # Run every 12 hours (at 6 AM and 6 PM UTC)
    - cron: '0 6,18 * * *'
  workflow_dispatch:  # Allow manual triggers

env:
  ML_API_URL: https://ml-api-production-6cfc.up.railway.app
  BACKEND_API_URL: https://backend-api-production-7b7d.up.railway.app
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    outputs:
      ml_healthy: ${{ steps.check.outputs.ml_healthy }}
      backend_healthy: ${{ steps.check.outputs.backend_healthy }}
    steps:
      - name: Check API Health
        id: check
        run: |
          echo "ðŸ©º Checking FixtureCast Services..."

          # Check ML API
          ML_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" $ML_API_URL/health 2>/dev/null || echo "000")
          if [ "$ML_STATUS" = "200" ]; then
            echo "ml_healthy=true" >> $GITHUB_OUTPUT
            echo "âœ… ML API is healthy (HTTP $ML_STATUS)"
          else
            echo "ml_healthy=false" >> $GITHUB_OUTPUT
            echo "âŒ ML API is unhealthy (HTTP $ML_STATUS)"
          fi

          # Check Backend API
          BACKEND_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" $BACKEND_API_URL/health 2>/dev/null || echo "000")
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "backend_healthy=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend API is healthy (HTTP $BACKEND_STATUS)"
          else
            echo "backend_healthy=false" >> $GITHUB_OUTPUT
            echo "âŒ Backend API is unhealthy (HTTP $BACKEND_STATUS)"
          fi

      - name: Health Summary
        run: |
          echo "## ðŸ©º Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.ml_healthy }}" = "true" ]; then
            echo "| ML API | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ML API | âŒ Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.check.outputs.backend_healthy }}" = "true" ]; then
            echo "| Backend API | âœ… Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Backend API | âŒ Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Last checked: $(date -u)_" >> $GITHUB_STEP_SUMMARY

  auto-restart-ml:
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.ml_healthy == 'false'
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.com/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Restart ML API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ”„ Attempting to restart ML API..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} || true
          railway redeploy -s web -y || echo "Note: May need manual restart"
          echo "âœ… ML API restart triggered"

      - name: Notify Restart
        run: echo "âš ï¸ ML API was unhealthy and has been restarted"

  auto-restart-backend:
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.backend_healthy == 'false'
    steps:
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.com/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Restart Backend API
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ”„ Attempting to restart Backend API..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }} || true
          railway redeploy -s backend-api -y || echo "Note: May need manual restart"
          echo "âœ… Backend API restart triggered"

      - name: Notify Restart
        run: echo "âš ï¸ Backend API was unhealthy and has been restarted"

  verify-recovery:
    runs-on: ubuntu-latest
    needs: [auto-restart-ml, auto-restart-backend]
    if: always() && (needs.auto-restart-ml.result == 'success' || needs.auto-restart-backend.result == 'success')
    steps:
      - name: Wait for restart
        run: sleep 120  # Wait 2 minutes for Railway to restart

      - name: Verify recovery
        run: |
          echo "ðŸ” Verifying service recovery..."

          ML_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" $ML_API_URL/health 2>/dev/null || echo "000")
          BACKEND_STATUS=$(curl -sf -o /dev/null -w "%{http_code}" $BACKEND_API_URL/health 2>/dev/null || echo "000")

          echo "## ðŸ”„ Recovery Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$ML_STATUS" = "200" ]; then
            echo "âœ… ML API recovered (HTTP $ML_STATUS)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ML API still unhealthy (HTTP $ML_STATUS) - Manual intervention required!" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… Backend API recovered (HTTP $BACKEND_STATUS)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Backend API still unhealthy (HTTP $BACKEND_STATUS) - Manual intervention required!" >> $GITHUB_STEP_SUMMARY
          fi
