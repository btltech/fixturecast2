name: Automated Weekly Training

on:
  schedule:
    # Run every Monday at 3 AM UTC
    - cron: "0 3 * * 1"
  push:
    branches:
      - main
  # Allow manual trigger
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      collect_data:
        description: 'Collect fresh data from API'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache training data
        uses: actions/cache@v3
        with:
          path: data/historical
          key: training-data-${{ github.run_id }}
          restore-keys: |
            training-data-

      - name: Cache feedback data
        uses: actions/cache@v3
        with:
          path: ml_engine/trained_models/feedback
          key: feedback-data-${{ github.run_id }}
          restore-keys: |
            feedback-data-

      - name: Backtest Previous Models
        env:
          BACKEND_API_URL: https://backend-api-production-7b7d.up.railway.app
          ML_API_URL: https://ml-api-production-6cfc.up.railway.app
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        run: |
          echo "üìä Backtesting previous week's models on recent matches..."
          # This uses the models from the last commit (previous week)
          # to see how they would have performed on matches that just finished
          python -u ml_engine/backtest_weekly.py
        continue-on-error: true

      - name: Train models
        env:
          API_FOOTBALL_KEY: ${{ secrets.API_FOOTBALL_KEY }}
        run: |
          cd ml_engine
          # Run with data collection enabled (remove --no-collect)
          # Use --train to ensure models are retrained
          python -u continuous_training.py --train
        continue-on-error: false

      - name: Verify models created
        id: verify_models
        run: |
          if [ -f "ml_engine/trained_models/gbdt_model.pkl" ] && [ -f "ml_engine/trained_models/meta_model.pkl" ]; then
            echo "models_valid=true" >> $GITHUB_OUTPUT
            echo "‚úì All models trained successfully"
            ls -la ml_engine/trained_models/*.pkl
          else
            echo "models_valid=false" >> $GITHUB_OUTPUT
            echo "‚úó Some models are missing!"
            ls -la ml_engine/trained_models/
            exit 1
          fi

      - name: Check if models changed
        id: check_changes
        run: |
          # Add both models and backtest history
          git add ml_engine/trained_models/
          git add backend/backtest_history.json || true

          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Files have changed:"
            git diff --staged --stat
          fi

      - name: Commit and push models
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore: Update models and backtest results - $(date +'%Y-%m-%d %H:%M:%S UTC')"

          # Pull latest changes and retry push up to 3 times
          max_retries=3
          for i in $(seq 1 $max_retries); do
            echo "Push attempt $i of $max_retries..."
            if git pull --rebase origin main && git push origin main; then
              echo "‚úì Push successful!"
              break
            else
              if [ $i -eq $max_retries ]; then
                echo "‚úó Push failed after $max_retries attempts"
                exit 1
              fi
              echo "Push failed, waiting 10 seconds before retry..."
              sleep 10
            fi
          done

      - name: Trigger Railway deployment
        if: steps.check_changes.outputs.changed == 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ ! -z "$RAILWAY_TOKEN" ]; then
            echo "‚úì Models pushed - Railway will auto-deploy if connected to GitHub"
            # Railway auto-deploys on git push when connected
          else
            echo "‚ö† RAILWAY_TOKEN not set - manual deployment may be needed"
          fi

      - name: Notify on success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ ! -z "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d "{
                \"content\": \"‚úÖ **FixtureCast Training Completed**\",
                \"embeds\": [{
                  \"title\": \"Weekly Model Training\",
                  \"description\": \"Models have been successfully trained and updated!\",
                  \"color\": 65280,
                  \"fields\": [
                    {\"name\": \"Status\", \"value\": \"‚úÖ Training completed successfully\", \"inline\": true},
                    {\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                    {\"name\": \"Run\", \"value\": \"[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                  ],
                  \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"
                }]
              }"
          else
            echo "‚úÖ Training pipeline completed successfully"
            echo "Models updated and committed to repository"
          fi

      - name: Notify on failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ ! -z "$DISCORD_WEBHOOK" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d "{
                \"content\": \"‚ùå **FixtureCast Training Failed**\",
                \"embeds\": [{
                  \"title\": \"Weekly Model Training\",
                  \"description\": \"The automated model training pipeline failed.\",
                  \"color\": 16711680,
                  \"fields\": [
                    {\"name\": \"Repository\", \"value\": \"${{ github.repository }}\", \"inline\": true},
                    {\"name\": \"Run\", \"value\": \"[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true}
                  ],
                  \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"
                }]
              }"
          fi
